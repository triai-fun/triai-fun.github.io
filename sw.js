"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,s){function a(e){try{c(r.next(e))}catch(e){s(e)}}function i(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,i)}c((r=r.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,r,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=i(0),a.throw=i(1),a.return=i(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,i[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},PREV_FIX_API="/pump/api/",_self=self,fetchPromiseMapSize=0,fetchPromiseMap=new Map;function sendMessageToClient(e){return _self.clients.matchAll().then(function(t){var n;switch(e.consumeType){case"all":t.forEach(function(t){t.postMessage(e.message)});break;case"one":null===(n=_ArrayUtils.toShuffled(t).find(function(e){return e}))||void 0===n||n.postMessage(e.message)}})}function receiveMessageFromClient(e,t){switch(e.event){case"request-logout":httpRequestAuthorizationInterceptor.clearUserToken(),sendMessageToClient({consumeType:"all",message:{event:"login_status_change",data:"confirm-logout"}});break;case"update_uesr_token":httpRequestAuthorizationInterceptor.userToken=e.data}}_self.addEventListener("fetch",function(e){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,s,a,i,c,u,l,h,p,f,d=this;return __generator(this,function(v){switch(v.label){case 0:new URL(e.request.url),t=0,n=ignoreFetchInterceptors,v.label=1;case 1:return t<n.length?(r=n[t],(u=r.checker(e.request))instanceof Promise?[4,u]:[3,3]):[3,5];case 2:u=v.sent(),v.label=3;case 3:if(u)return[2];v.label=4;case 4:return t++,[3,1];case 5:e.request.signal.addEventListener("abort",function(t){console.log("event stop by abort",e.request.url)}),o=e.request,s=!1,a=0,i=interceptors,v.label=6;case 6:return a<i.length?(c=i[a]).checker(o)?(s=!0,[4,(u=c.preHandle(e.request))instanceof Promise?u:Promise.resolve(u)]):[3,8]:[3,9];case 7:if((l=v.sent())instanceof Request)return o=l,[3,9];if(l instanceof Response)return[2,e.respondWith(l)];if(!l){console.log("It's intercept by sw:".concat(o.url)),h=new Response("Intercepted by ".concat(c.constructor.name));try{e.respondWith(h)}catch(t){console.error("intercept error",e.request.url,t)}}v.label=8;case 8:return a++,[3,6];case 9:if(!s)return[2];p=o.clone(),f=fetch(o,{signal:o.signal}).then(function(e){return __awaiter(d,void 0,void 0,function(){var t,n,r,o;return __generator(this,function(s){switch(s.label){case 0:t=e.clone(),n=0,r=interceptors,s.label=1;case 1:return n<r.length?"function"==typeof(o=r[n]).postHandle&&o.checker(p)?[4,o.postHandle(p,t)]:[3,3]:[3,4];case 2:t=s.sent(),s.label=3;case 3:return n++,[3,1];case 4:return[2,t]}})})});try{e.respondWith(f)}catch(t){console.error("event respond error",e.request.url,t)}return[2]}})})}),_self.addEventListener("install",function(e){_self.skipWaiting()}),_self.addEventListener("activate",function(e){e.waitUntil(_self.clients.claim())}),_self.addEventListener("message",function(e){receiveMessageFromClient(e.data,e)});var cache,NextJSInterceptor=function(){function e(){}return e.prototype.checker=function(e){var t=new URL(e.url);return(t.pathname.includes(".")||t.pathname.endsWith("css")||t.pathname.endsWith("css2")||t.pathname.includes("_nextjs_")||t.pathname.split("/").length<=1)&&"GET"===e.method},e}(),PageInterceptor=function(){function e(){}return e.prototype.checker=function(e){return!new URL(e.url).pathname.startsWith(PREV_FIX_API)&&"GET"===e.method},e}(),ignoreFetchInterceptors=[new NextJSInterceptor,new PageInterceptor],RepeatFetchInterceptor=function(){function e(){}return e.prototype.checker=function(e){var t,n={url:e.url,method:e.method,body:e.body};return fetchPromiseMap.has(n)&&isRequestsEqual(e,null===(t=fetchPromiseMap.get(e))||void 0===t?void 0:t.request)},e.prototype.preHandle=function(e){var t;return console.log("Match request cache by sw:".concat(e.url)),null===(t=fetchPromiseMap.get(e))||void 0===t?void 0:t.promise},e}(),HttpRequestAuthorizationInterceptor=function(){function e(){this.KEY="Authorization",this._userToken=null}return Object.defineProperty(e.prototype,"userToken",{get:function(){var e;return null!==(e=this._userToken)&&void 0!==e?e:""},set:function(e){console.log("set userToken"),this._userToken=e},enumerable:!1,configurable:!0}),e.prototype.clearUserToken=function(){this._userToken=null},e.prototype.clearUserTokenAndTokenStore=function(){this._userToken=null,sendMessageToClient({consumeType:"all",message:{event:"login_status_change",data:"request-logout"}})},e.prototype.checker=function(e){var t=new URL(e.url);return t.pathname.startsWith("".concat(PREV_FIX_API))&&(this.checkIsUserApi(t)||this.checkIsUserDao(t))},e.prototype.checkIsUserApi=function(e){return e.pathname.endsWith("/login")||e.pathname.includes("/my-asset/")||e.pathname.endsWith("/user")},e.prototype.checkIsUserDao=function(e){return e.pathname.endsWith("/vote/daos")||e.pathname.endsWith("/vote/dao/detail")||e.pathname.endsWith("/vote/dao/apply")||e.pathname.includes("/vote/my/")||e.pathname.includes("/vote/last/claim")},e.prototype.preHandle=function(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){return console.info("request.url",e.url),e.url.endsWith("/login")?(this.clearUserToken(),[2,!0]):this.userToken?e.headers.has(this.KEY)?[2,!0]:((t=new Headers(e.headers)).set(this.KEY,this.userToken),[2,new Request(e,{headers:t})]):e.url.endsWith("/user")&&e.headers.has(this.KEY)?(this.userToken=e.headers.get(this.KEY),[2,!0]):[2,!0]})})},e.prototype.postHandle=function(e,t){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(r){switch(r.label){case 0:return e.url.includes("".concat(PREV_FIX_API))&&e.url.endsWith("/login")?!t.ok||t.bodyUsed?[2,t]:[4,t.clone().json()]:[2,t];case 1:return"E0001"===(n=r.sent()).code&&e.headers.get(this.KEY)&&this.clearUserTokenAndTokenStore(),"0"!==n.code?[2,t]:(this.userToken=n.data.token,[2,t])}})})},e}();caches.open("sw_cache").then(function(e){cache=e});var httpRequestAuthorizationInterceptor=new HttpRequestAuthorizationInterceptor,interceptors=[httpRequestAuthorizationInterceptor],_ArrayUtils=function(){function e(){}return e.toShuffled=function(e){for(var t,n=e.toSorted(),r=n.length-1;r>0;r--){var o=Math.floor(Math.random()*(r+1));t=[e[o],e[r]],n[r]=t[0],n[o]=t[1]}return n},e}();function isRequestsEqual(e,t){var n=e.url===t.url,r=e.method===t.method,o=["content-type","authorization"].every(function(n){return e.headers.get(n)===t.headers.get(n)}),s="POST"!==e.method&&"PUT"!==e.method||e.body===t.body;return n&&r&&o&&s}